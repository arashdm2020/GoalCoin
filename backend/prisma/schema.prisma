// Prisma schema for GoalCoin MVP - Aligned with James's Technical Annex

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Core User and Challenge Models ---

model User {
  id                String        @id @default(cuid())
  wallet            String?       @unique
  email             String?       @unique
  password_hash     String?
  email_verified    Boolean       @default(false)
  handle            String?       @unique
  country_code      String?
  tier              UserTier      @default(FAN)
  fan_tier          UserTier?
  tier_updated_at   DateTime?
  founder_nft       Boolean       @default(false)
  
  // XP and Streak System
  xp_points         Int           @default(0)
  goal_points       Int           @default(0)
  current_streak    Int           @default(0)
  longest_streak    Int           @default(0)
  last_activity_date DateTime?
  burn_multiplier   Float         @default(1.0)
  
  // Utility Bridge for Non-Holders
  is_holder         Boolean       @default(false)
  micro_goal_points Int           @default(0)
  
  // Streak Protection Features
  grace_days_remaining       Int       @default(2)
  grace_days_used_this_month Int       @default(0)
  streak_freeze_tokens       Int       @default(0)
  streak_frozen_until        DateTime?
  
  created_at        DateTime      @default(now())
  payments          Payment[]
  submissions       Submission[]
  warmup_logs       WarmupLog[]
  workout_logs      WorkoutLog[]
  meal_logs         MealLog[]
  referrals_made    Referral[]    @relation("Referrer")
  referrals_received Referral[]   @relation("Referred")
  ad_views          AdView[]
  reviewer          Reviewer?
  notifications     Notification[]

  @@map("users")
}

model Challenge {
  id          String       @id @default(cuid())
  title       String       @default("90-Day Challenge")
  start_date  DateTime
  end_date    DateTime
  rules       String?      // For storing rules text or link
  active      Boolean      @default(true)
  submissions Submission[]

  @@map("challenges")
}

model Payment {
  id          String       @id @default(cuid())
  user        User         @relation(fields: [user_id], references: [id])
  user_id     String
  tx_id       String       @unique // From CoinPayments
  amount      Float
  tier        PaymentTier
  status      String       @default("pending") // e.g., pending, confirmed, failed
  paid_at     DateTime?
  raw_webhook Json?
  created_at  DateTime     @default(now())
  ledger_entry PoolsLedger? 

  @@map("payments")
}

// --- Submission, Review, and Payout Models ---

model Submission {
  id              String             @id @default(cuid())
  user            User               @relation(fields: [user_id], references: [id])
  user_id         String
  challenge       Challenge          @relation(fields: [challenge_id], references: [id])
  challenge_id    String
  week_no         Int
  file_url        String
  watermark_code  String
  status          SubmissionStatus   @default(PENDING)
  created_at      DateTime           @default(now())
  closed_at       DateTime?
  assignments     ReviewAssignment[]
  reviews         Review[]

  @@map("submissions")
}

model ReviewAssignment {
  id              String    @id @default(cuid())
  submission      Submission @relation(fields: [submission_id], references: [id])
  submission_id   String
  reviewer_wallet String
  assigned_at     DateTime  @default(now())
  expires_at      DateTime
  status          AssignmentStatus @default(PENDING)
  review          Review?   

  @@map("review_assignments")
  @@index([reviewer_wallet, assigned_at])
}

model Review {
  id              String           @id @default(cuid())
  submission      Submission       @relation(fields: [submission_id], references: [id])
  submission_id   String
  reviewer_wallet String
  vote            VoteType
  voted_at        DateTime         @default(now())
  assignment      ReviewAssignment @relation(fields: [assignment_id], references: [id])
  assignment_id   String           @unique

  @@map("reviews")
}

model Reviewer {
  id              String          @id @default(cuid())
  user            User            @relation(fields: [user_id], references: [id])
  user_id         String          @unique
  voting_weight   Int             @default(1)
  strikes         Int             @default(0)
  status          ReviewerStatus  @default(ACTIVE)
  created_at      DateTime        @default(now())

  @@map("reviewers")
}

model Commission {
  id              String   @id @default(cuid())
  reviewer_wallet String
  submission_id   String
  amount_usdt     Float
  earned_at       DateTime @default(now())
  payout          Payout?  @relation(fields: [payout_id], references: [id])
  payout_id       String?

  @@map("commissions")
}

model Payout {
  id            String       @id @default(cuid())
  reviewer_wallet String
  amount_usdt   Float
  tx_hash       String?
  period_start  DateTime
  period_end    DateTime
  status        PayoutStatus @default(PENDING)
  created_at    DateTime     @default(now())
  commissions   Commission[]

  @@map("payouts")
}

// --- Financial and Ledger Models ---

model PoolsLedger {
  id           String   @id @default(cuid())
  payment      Payment  @relation(fields: [payment_id], references: [id])
  payment_id   String   @unique
  prize_usdt   Float
  treasury_usdt Float
  burn_usdt    Float
  created_at   DateTime @default(now())

  @@map("pools_ledger")
}

// --- Admin & Audit Log Models ---

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // e.g., "REVIEWER_ADDED", "VOTE_SUBMITTED", "PAYOUT_CREATED"
  entity_type String   // e.g., "reviewer", "submission", "payout"
  entity_id   String   // ID of the affected entity
  user_wallet String?  // Wallet of user who performed action
  admin_user  String?  // Admin username who performed action
  old_data    Json?    // Previous state (for updates)
  new_data    Json?    // New state
  created_at  DateTime @default(now())

  @@map("audit_logs")
}

model AdminLog {
  id          String   @id @default(cuid())
  admin_user  String   // Admin username
  action      String   // e.g., "FORCE_APPROVE_SUBMISSION"
  target_id   String   // ID of the entity being acted upon
  reason      String?  // Optional reason for the action
  created_at  DateTime @default(now())

  @@map("admin_logs")
}

// --- Fitness MVP Add-Ons ---

model WarmupSession {
  id          String   @id @default(cuid())
  title       String
  description String?
  video_url   String?
  duration_min Int     @default(5)
  order       Int      @default(0)
  active      Boolean  @default(true)
  created_at  DateTime @default(now())
  logs        WarmupLog[]

  @@map("warmup_sessions")
}

model WarmupLog {
  id               String         @id @default(cuid())
  user             User           @relation(fields: [user_id], references: [id])
  user_id          String
  session          WarmupSession? @relation(fields: [session_id], references: [id])
  session_id       String?
  routine_id       String         // ID from warmup catalog
  duration_seconds Int            @default(300)
  completed        Boolean        @default(true)
  xp_earned        Int            @default(5)
  completed_at     DateTime       @default(now())

  @@map("warmup_logs")
  @@index([user_id, completed_at])
}

model WorkoutLog {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [user_id], references: [id])
  user_id     String
  workout_type String  // e.g., "cardio", "strength", "flexibility"
  duration_min Int
  notes       String?  // Optional notes about the workout
  xp_earned   Int      @default(20)
  completed_at DateTime @default(now())

  @@map("workout_logs")
  @@index([user_id, completed_at])
}

model DietPlan {
  id          String   @id @default(cuid())
  title       String   // e.g., "GoalCoin Meal of the Day"
  tier        DietTier @default(BALANCED)
  region      String?  // e.g., "Middle East", "Asia", "Western"
  description String
  ingredients String?  // Text-based list
  instructions String? // Cooking instructions
  calories    Int?
  protein_g   Int?
  active      Boolean  @default(true)
  created_at  DateTime @default(now())
  logs        MealLog[]

  @@map("diet_plans")
}

model MealLog {
  id           String    @id @default(cuid())
  user         User      @relation(fields: [user_id], references: [id])
  user_id      String
  plan         DietPlan? @relation(fields: [plan_id], references: [id])
  plan_id      String?
  meal_id      String    // ID from meal catalog
  meal_type    String    // breakfast, lunch, dinner, snack
  calories     Int       @default(0)
  completed    Boolean   @default(true)
  xp_earned    Int       @default(5)
  logged_at    DateTime  @default(now())
  completed_at DateTime  @default(now())

  @@map("meal_logs")
  @@index([user_id, logged_at])
  @@index([user_id, completed_at])
}

// --- Utility Bridge Models ---

model Referral {
  id            String    @id @default(cuid())
  referrer      User      @relation("Referrer", fields: [referrer_id], references: [id])
  referrer_id   String
  referred      User      @relation("Referred", fields: [referred_id], references: [id])
  referred_id   String
  reward_points Int       @default(50)
  status        String    @default("signed_up") // signed_up, activated, fraud_flag
  activated_at  DateTime?
  created_at    DateTime  @default(now())

  @@map("referrals")
  @@unique([referrer_id, referred_id])
  @@index([referrer_id, status])
  @@index([status, created_at])
}

model AdView {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [user_id], references: [id])
  user_id     String
  ad_type     String   // e.g., "video", "banner"
  reward_points Int    @default(5)
  viewed_at   DateTime @default(now())

  @@map("ad_views")
  @@index([user_id, viewed_at])
}

// --- DAO Governance ---

model DaoProposal {
  id          String   @id @default(cuid())
  title       String
  description String
  proposer_wallet String
  status      ProposalStatus @default(ACTIVE)
  votes_for   Int      @default(0)
  votes_against Int    @default(0)
  created_at  DateTime @default(now())
  expires_at  DateTime
  votes       DaoVote[]

  @@map("dao_proposals")
}

model DaoVote {
  id          String   @id @default(cuid())
  proposal    DaoProposal @relation(fields: [proposal_id], references: [id])
  proposal_id String
  voter_wallet String
  vote_type   VoteType
  vote_count  Int      @default(1) // Max 2 per wallet
  voted_at    DateTime @default(now())

  @@map("dao_votes")
  @@unique([proposal_id, voter_wallet])
}

// --- Treasury & Burn Tracking ---

model BurnEvent {
  id          String   @id @default(cuid())
  amount_goalcoin Float
  tx_hash     String?
  source      String   // e.g., "treasury_buyback", "streak_multiplier"
  created_at  DateTime @default(now())

  @@map("burn_events")
}

model ShopifyRedemption {
  id          String   @id @default(cuid())
  order_code  String   @unique
  user_id     String
  redeemed_at DateTime @default(now())

  @@map("shopify_redemptions")
}

model TestStake {
  id          String    @id @default(cuid())
  wallet      String
  amount_usd  Float
  network     String    // e.g., "mumbai", "polygon"
  status      String    // "pending", "active", "unstaked"
  tx_hash     String?
  created_at  DateTime  @default(now())
  unstaked_at DateTime?

  @@map("test_stakes")
}

model FeatureToggle {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Boolean  @default(false)
  description String?
  updated_at  DateTime @updatedAt

  @@map("feature_toggles")
}

// --- Enums ---

enum UserTier {
  FAN
  FOUNDER
  PLAYER
}

enum PaymentTier {
  TIER_19
  TIER_35
  TIER_49
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  APPEAL
}

enum AssignmentStatus {
  PENDING
  VOTED
  REASSIGNED
}

enum VoteType {
  APPROVE
  REJECT
}

enum PayoutStatus {
  PENDING
  PAID
  FAILED
}

enum ReviewerStatus {
  ACTIVE
  SUSPENDED
}

enum DietTier {
  BUDGET
  BALANCED
  PROTEIN_BOOST
}

enum ProposalStatus {
  ACTIVE
  PASSED
  REJECTED
  EXPIRED
}

// --- Notification System ---

model Notification {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id    String
  type       String
  title      String
  message    String
  read       Boolean  @default(false)
  metadata   Json?
  created_at DateTime @default(now())
  
  @@map("notifications")
  @@index([user_id, read])
  @@index([user_id, created_at])
}
